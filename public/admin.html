<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Area Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h2, h3 {
      color: #333;
      margin-top: 30px;
    }

    #login {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 40px;
    }

    #login input {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    #login button {
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #login button:hover {
      background-color: #0056b3;
    }

    #errore {
      color: red;
      font-weight: bold;
    }

    #admin {
      width: 100%;
      max-width: 900px;
      margin-top: 40px;
    }

    #medie {
      margin-bottom: 30px;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    #medie p {
      font-size: 18px;
      margin: 6px 0;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
      overflow: hidden;
    }

    th {
      background-color: #007bff;
      color: white;
      padding: 10px;
      text-align: left;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>

  <h2>Area Riservata</h2>

  <div id="login">
    <input type="password" id="adminPass" placeholder="Password">
    <button onclick="login()">Accedi</button>
    <p id="errore"></p>
  </div>

  <div id="admin" style="display: none;">
    <div id="medie">
      <h3>Medie globali</h3>
      <p>Internazionale: <span id="avgInt">-</span></p>
      <p>Italiano: <span id="avgIta">-</span></p>
      <p>Pubblicitario: <span id="avgAdv">-</span></p>
    </div>
    <div style="margin-bottom: 30px; display: flex; gap: 10px;">
  <button onclick="svuotaDatabase()" style="padding: 10px; background-color: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
    üß® Svuota Database
  </button>
  <button onclick="generaPDF()" style="padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
    üìÑ Scarica PDF
  </button>
</div>
    <h3>Dati inseriti</h3>
    <table>
      <thead>
        <tr>
          <th>Internazionale</th>
          <th>Italiano</th>
          <th>Pubblicitario</th>
        </tr>
      </thead>
      <tbody id="tabellaDati"></tbody>
    </table>
  </div>

  <script>
    let token = null;

    async function login() {
      const password = document.getElementById("adminPass").value;
      const res = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      if (!res.ok) {
        document.getElementById("errore").textContent = "‚ùå Password errata";
        return;
      }

      const data = await res.json();
      token = data.token;

      document.getElementById("login").style.display = "none";
      document.getElementById("admin").style.display = "block";
      caricaDati();
      caricaMedia();
    }

    async function caricaDati() {
      const res = await fetch('/api/admin/dati', {
        headers: { Authorization: token }
      });
      const dati = await res.json();

      const tabella = document.getElementById("tabellaDati");
      tabella.innerHTML = "";

      dati.forEach(riga => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${riga.intSet}</td>
          <td>${riga.itaSet}</td>
          <td>${riga.advSet}</td>
        `;
        tabella.appendChild(tr);
      });
    }

    async function caricaMedia() {
      const res = await fetch('/api/media');
      const media = await res.json();

      document.getElementById("avgInt").textContent = media.int.toFixed(2);
      document.getElementById("avgIta").textContent = media.ita.toFixed(2);
      document.getElementById("avgAdv").textContent = media.adv.toFixed(2);
      document.getElementById("medie").style.display = "block";
    }
    async function svuotaDatabase() {
  if (!confirm("‚ö†Ô∏è Sei sicuro di voler cancellare tutti i dati?")) return;

  const res = await fetch('/api/admin/reset', {
    method: 'POST',
    headers: { Authorization: token }
  });

  if (res.ok) {
    alert("‚úÖ Database svuotato");
    caricaDati();
    caricaMedia();
  } else {
    alert("‚ùå Errore nel reset");
  }
}

async function generaPDF() {
  const res = await fetch('/api/admin/pdf', {
    method: 'GET',
    headers: { Authorization: token }
  });

  if (!res.ok) {
    alert("‚ùå Errore nel generare il PDF");
    return;
  }

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = "riepilogo.pdf";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  window.URL.revokeObjectURL(url);
}

  </script>
</body>
</html>
